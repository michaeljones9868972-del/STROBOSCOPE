<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Погружение</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #000;
      font-family: Arial, sans-serif;
    }
    canvas {
      display: block;
    }
    .overlay {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-size: 24px;
      text-align: center;
      z-index: 10;
      transition: opacity 1s ease, visibility 0s 1s;
    }
    .overlay.hide {
      opacity: 0;
      pointer-events: none;
    }
    button {
      margin-top: 20px;
      padding: 12px 30px;
      font-size: 18px;
      background: #D5FB00;
      color: #223C20;
      border: none;
      border-radius: 30px;
      cursor: pointer;
      transition: 0.3s;
    }
    button:hover {
      background: #DE60CA;
      color: white;
    }
  </style>
</head>
<body>

  <!-- Всплывающее окно -->
  <div class="overlay" id="overlay">
    <h2>Погрузиться в анимацию</h2>
    <p>Через 3 секунды вы сможете войти в полноэкранный режим</p>
    <button id="fullscreenBtn" disabled>Войти в полноэкранный режим</button>
  </div>

  <script>
    let MAX_INIT_SIZE, MAX_ANGLE_STEP, SIZE_MULT, MIN_SIZE;
    let initSize, initAngle, initColIndex;
    let url = "https://coolors.co/app/223C20-4C8D26-D5FB00-DE60CA-882380";
    let cols;
    let isFullscreen = false;

    function setup() {
      createCanvas(windowWidth, windowHeight);
      rectMode(CENTER);
      noStroke();
      cols = createCols(url);

      MAX_INIT_SIZE = max(width, height) * 0.35;
      MAX_ANGLE_STEP = PI / 20;
      SIZE_MULT = 0.88;
      MIN_SIZE = 12;

      initSize = MAX_INIT_SIZE;
      initAngle = 0;
      initColIndex = 0;

      // Активация кнопки через 3 секунды
      setTimeout(() => {
        document.getElementById('fullscreenBtn').disabled = false;
        document.getElementById('fullscreenBtn').innerText = "Погрузиться в анимацию";
      }, 3000);

      // Кнопка на весь экран
      document.getElementById('fullscreenBtn').addEventListener('click', enterFullscreen);
    }

    function draw() {
      background(0);

      // Показываем overlay только в начале
      if (isFullscreen || document.querySelector('.overlay').style.display === 'none') {
        let count = sin(frameCount / 150);
        let angleStep = MAX_ANGLE_STEP * count;
        let colIndex = initColIndex;
        let size = initSize;
        let angle = initAngle;

        while (size > MIN_SIZE) {
          push();
          translate(width / 2, height / 2);
          rotate(angle);
          fill(cols[colIndex % cols.length]);
          ellipse(0, 0, size, size * 0.7); // круги
          pop();

          angle += angleStep * map(size, MIN_SIZE, MAX_INIT_SIZE, 1, 0, false);
          size *= SIZE_MULT;
          colIndex++;
        }

        initSize -= MAX_INIT_SIZE * 0.0015 * (10 + abs(count));
        initAngle += angleStep * 0.1;

        if (initSize < MAX_INIT_SIZE * SIZE_MULT) {
          initSize /= SIZE_MULT;
          initColIndex = (initColIndex + cols.length - 1) % cols.length;
        }
      }
    }

    function enterFullscreen() {
      const elem = document.documentElement;
      if (elem.requestFullscreen) {
        elem.requestFullscreen();
      } else if (elem.webkitRequestFullscreen) { /* Safari */
        elem.webkitRequestFullscreen();
      } else if (elem.msRequestFullscreen) { /* IE11 */
        elem.msRequestFullscreen();
      }

      // Скрываем overlay
      document.getElementById('overlay').style.display = 'none';
      isFullscreen = true;
    }

    function mouseMoved() {
      // При движении мыши — показываем overlay (для выхода)
      if (isFullscreen && (mouseX < 0 || mouseX > width || mouseY < 0 || mouseY > height)) {
        return;
      }
      showExitHint();
    }

    function keyPressed() {
      if (keyCode === ESC || keyCode === 32) { // Esc или пробел
        exitFullscreen();
      }
    }

    function showExitHint() {
      const overlay = document.getElementById('overlay');
      overlay.innerHTML = `
        <h2>Выход из режима погружения</h2>
        <p>Нажмите ESC или пробел, чтобы выйти</p>
        <button onclick="exitFullscreen()">Выйти</button>
      `;
      overlay.style.display = 'flex';
      overlay.classList.remove('hide');
    }

    function exitFullscreen() {
      if (document.exitFullscreen) {
        document.exitFullscreen();
      } else if (document.webkitExitFullscreen) {
        document.webkitExitFullscreen();
      } else if (document.msExitFullscreen) {
        document.msExitFullscreen();
      }
      document.getElementById('overlay').style.display = 'none';
      isFullscreen = false;
    }

    function windowResized() {
      resizeCanvas(windowWidth, windowHeight);
      MAX_INIT_SIZE = max(width, height) * 0.35;
    }

    // Закрыть overlay при загрузке (если JS работает)
    window.addEventListener('load', () => {
      setTimeout(() => {
        const overlay = document.getElementById('overlay');
        if (!isFullscreen) return;
        overlay.classList.add('hide');
      }, 5000);
    });
  </script>
</body>
</html>
